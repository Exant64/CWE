#include "stdafx.h"

#include "ninja_functions.h"
#include "collision_debug.h"

#include "data/debugsphere.h"

#pragma warning(push)
#pragma warning( disable: 4838 )
Sint32 vertex_8D92D450B41AF90ED15[] = { 0x2D10029, 0x780000, 0x410A9066, 0xC1200000u, 0xC0A00000u, 0x3F1A06EA, 0xBF382118u, 0xBEB1DAE0u, 0x41200000, 0xC1200000u, 0x0, 0x3F31DAF0, 0xBF382118u, 0x0, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0x41200000, 0x41200000, 0x0, 0x3F31DAF0, 0x3F382118, 0x0, 0x410A9066, 0x41200000, 0xC0A00000u, 0x3F1A06EA, 0x3F382118, 0xBEB1DAE0u, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0x40A00000, 0xC1200000u, 0xC10A9066u, 0x3EB1DAE0, 0xBF382118u, 0xBF1A06EAu, 0x410A9066, 0xC1200000u, 0xC0A00000u, 0x3F1A06EA, 0xBF382118u, 0xBEB1DAE0u, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0x410A9066, 0x41200000, 0xC0A00000u, 0x3F1A06EA, 0x3F382118, 0xBEB1DAE0u, 0x40A00000, 0x41200000, 0xC10A9066u, 0x3EB1DAE0, 0x3F382118, 0xBF1A06EAu, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0x0, 0xC1200000u, 0xC11FFFFFu, 0x0, 0xBF382118u, 0xBF31DAF0u, 0x40A00000, 0xC1200000u, 0xC10A9066u, 0x3EB1DAE0, 0xBF382118u, 0xBF1A06EAu, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0x40A00000, 0x41200000, 0xC10A9066u, 0x3EB1DAE0, 0x3F382118, 0xBF1A06EAu, 0x0, 0x41200000, 0xC11FFFFFu, 0x0, 0x3F382118, 0xBF31DAF0u, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0xC0A00000u, 0xC1200000u, 0xC10A9066u, 0xBEB1DAE0u, 0xBF382118u, 0xBF1A06EAu, 0x0, 0xC1200000u, 0xC11FFFFFu, 0x0, 0xBF382118u, 0xBF31DAF0u, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0x0, 0x41200000, 0xC11FFFFFu, 0x0, 0x3F382118, 0xBF31DAF0u, 0xC0A00000u, 0x41200000, 0xC10A9066u, 0xBEB1DAE0u, 0x3F382118, 0xBF1A06EAu, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0xC10A9066u, 0xC1200000u, 0xC0A00000u, 0xBF1A06EAu, 0xBF382118u, 0xBEB1DAE0u, 0xC0A00000u, 0xC1200000u, 0xC10A9066u, 0xBEB1DAE0u, 0xBF382118u, 0xBF1A06EAu, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0xC0A00000u, 0x41200000, 0xC10A9066u, 0xBEB1DAE0u, 0x3F382118, 0xBF1A06EAu, 0xC10A9066u, 0x41200000, 0xC0A00000u, 0xBF1A06EAu, 0x3F382118, 0xBEB1DAE0u, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0xC1200000u, 0xC1200000u, 0x0, 0xBF31DAF0u, 0xBF382118u, 0x0, 0xC10A9066u, 0xC1200000u, 0xC0A00000u, 0xBF1A06EAu, 0xBF382118u, 0xBEB1DAE0u, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0xC10A9066u, 0x41200000, 0xC0A00000u, 0xBF1A06EAu, 0x3F382118, 0xBEB1DAE0u, 0xC1200000u, 0x41200000, 0x0, 0xBF31DAF0u, 0x3F382118, 0x0, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0xC10A9066u, 0xC1200000u, 0x40A00000, 0xBF1A06EAu, 0xBF382118u, 0x3EB1DAE0, 0xC1200000u, 0xC1200000u, 0x0, 0xBF31DAF0u, 0xBF382118u, 0x0, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0xC1200000u, 0x41200000, 0x0, 0xBF31DAF0u, 0x3F382118, 0x0, 0xC10A9066u, 0x41200000, 0x40A00000, 0xBF1A06EAu, 0x3F382118, 0x3EB1DAE0, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0xC0A00000u, 0xC1200000u, 0x410A9066, 0xBEB1DAE0u, 0xBF382118u, 0x3F1A06EA, 0xC10A9066u, 0xC1200000u, 0x40A00000, 0xBF1A06EAu, 0xBF382118u, 0x3EB1DAE0, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0xC10A9066u, 0x41200000, 0x40A00000, 0xBF1A06EAu, 0x3F382118, 0x3EB1DAE0, 0xC0A00000u, 0x41200000, 0x410A9066, 0xBEB1DAE0u, 0x3F382118, 0x3F1A06EA, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0x0, 0xC1200000u, 0x411FFFFF, 0x0, 0xBF382118u, 0x3F31DAF0, 0xC0A00000u, 0xC1200000u, 0x410A9066, 0xBEB1DAE0u, 0xBF382118u, 0x3F1A06EA, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0xC0A00000u, 0x41200000, 0x410A9066, 0xBEB1DAE0u, 0x3F382118, 0x3F1A06EA, 0x0, 0x41200000, 0x411FFFFF, 0x0, 0x3F382118, 0x3F31DAF0, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0x40A00000, 0xC1200000u, 0x410A9066, 0x3EB1DAE0, 0xBF382118u, 0x3F1A06EA, 0x0, 0xC1200000u, 0x411FFFFF, 0x0, 0xBF382118u, 0x3F31DAF0, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0x0, 0x41200000, 0x411FFFFF, 0x0, 0x3F382118, 0x3F31DAF0, 0x40A00000, 0x41200000, 0x410A9066, 0x3EB1DAE0, 0x3F382118, 0x3F1A06EA, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0x410A9066, 0xC1200000u, 0x40A00000, 0x3F1A06EA, 0xBF382118u, 0x3EB1DAE0, 0x40A00000, 0xC1200000u, 0x410A9066, 0x3EB1DAE0, 0xBF382118u, 0x3F1A06EA, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0x40A00000, 0x41200000, 0x410A9066, 0x3EB1DAE0, 0x3F382118, 0x3F1A06EA, 0x410A9066, 0x41200000, 0x40A00000, 0x3F1A06EA, 0x3F382118, 0x3EB1DAE0, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0x41200000, 0xC1200000u, 0x0, 0x3F31DAF0, 0xBF382118u, 0x0, 0x410A9066, 0xC1200000u, 0x40A00000, 0x3F1A06EA, 0xBF382118u, 0x3EB1DAE0, 0x0, 0xC1200000u, 0x0, 0x0, 0xBF800000u, 0x0, 0x410A9066, 0x41200000, 0x40A00000, 0x3F1A06EA, 0x3F382118, 0x3EB1DAE0, 0x41200000, 0x41200000, 0x0, 0x3F31DAF0, 0x3F382118, 0x0, 0x0, 0x41200000, 0x0, 0x0, 0x3F800000, 0x0, 0x41200000, 0xC1200000u, 0x0, 0x3F31DAF0, 0xBF382118u, 0x0, 0x410A9066, 0xC1200000u, 0xC0A00000u, 0x3F1A06EA, 0xBF382118u, 0xBEB1DAE0u, 0x41200000, 0x41200000, 0x0, 0x3F31DAF0, 0x3F382118, 0x0, 0x410A9066, 0x41200000, 0xC0A00000u, 0x3F1A06EA, 0x3F382118, 0xBEB1DAE0u, 0x410A9066, 0xC1200000u, 0xC0A00000u, 0x3F1A06EA, 0xBF382118u, 0xBEB1DAE0u, 0x40A00000, 0xC1200000u, 0xC10A9066u, 0x3EB1DAE0, 0xBF382118u, 0xBF1A06EAu, 0x410A9066, 0x41200000, 0xC0A00000u, 0x3F1A06EA, 0x3F382118, 0xBEB1DAE0u, 0x40A00000, 0x41200000, 0xC10A9066u, 0x3EB1DAE0, 0x3F382118, 0xBF1A06EAu, 0x40A00000, 0xC1200000u, 0xC10A9066u, 0x3EB1DAE0, 0xBF382118u, 0xBF1A06EAu, 0x0, 0xC1200000u, 0xC11FFFFFu, 0x0, 0xBF382118u, 0xBF31DAF0u, 0x40A00000, 0x41200000, 0xC10A9066u, 0x3EB1DAE0, 0x3F382118, 0xBF1A06EAu, 0x0, 0x41200000, 0xC11FFFFFu, 0x0, 0x3F382118, 0xBF31DAF0u, 0x0, 0xC1200000u, 0xC11FFFFFu, 0x0, 0xBF382118u, 0xBF31DAF0u, 0xC0A00000u, 0xC1200000u, 0xC10A9066u, 0xBEB1DAE0u, 0xBF382118u, 0xBF1A06EAu, 0x0, 0x41200000, 0xC11FFFFFu, 0x0, 0x3F382118, 0xBF31DAF0u, 0xC0A00000u, 0x41200000, 0xC10A9066u, 0xBEB1DAE0u, 0x3F382118, 0xBF1A06EAu, 0xC0A00000u, 0xC1200000u, 0xC10A9066u, 0xBEB1DAE0u, 0xBF382118u, 0xBF1A06EAu, 0xC10A9066u, 0xC1200000u, 0xC0A00000u, 0xBF1A06EAu, 0xBF382118u, 0xBEB1DAE0u, 0xC0A00000u, 0x41200000, 0xC10A9066u, 0xBEB1DAE0u, 0x3F382118, 0xBF1A06EAu, 0xC10A9066u, 0x41200000, 0xC0A00000u, 0xBF1A06EAu, 0x3F382118, 0xBEB1DAE0u, 0xC10A9066u, 0xC1200000u, 0xC0A00000u, 0xBF1A06EAu, 0xBF382118u, 0xBEB1DAE0u, 0xC1200000u, 0xC1200000u, 0x0, 0xBF31DAF0u, 0xBF382118u, 0x0, 0xC10A9066u, 0x41200000, 0xC0A00000u, 0xBF1A06EAu, 0x3F382118, 0xBEB1DAE0u, 0xC1200000u, 0x41200000, 0x0, 0xBF31DAF0u, 0x3F382118, 0x0, 0xC1200000u, 0xC1200000u, 0x0, 0xBF31DAF0u, 0xBF382118u, 0x0, 0xC10A9066u, 0xC1200000u, 0x40A00000, 0xBF1A06EAu, 0xBF382118u, 0x3EB1DAE0, 0xC1200000u, 0x41200000, 0x0, 0xBF31DAF0u, 0x3F382118, 0x0, 0xC10A9066u, 0x41200000, 0x40A00000, 0xBF1A06EAu, 0x3F382118, 0x3EB1DAE0, 0xC10A9066u, 0xC1200000u, 0x40A00000, 0xBF1A06EAu, 0xBF382118u, 0x3EB1DAE0, 0xC0A00000u, 0xC1200000u, 0x410A9066, 0xBEB1DAE0u, 0xBF382118u, 0x3F1A06EA, 0xC10A9066u, 0x41200000, 0x40A00000, 0xBF1A06EAu, 0x3F382118, 0x3EB1DAE0, 0xC0A00000u, 0x41200000, 0x410A9066, 0xBEB1DAE0u, 0x3F382118, 0x3F1A06EA, 0xC0A00000u, 0xC1200000u, 0x410A9066, 0xBEB1DAE0u, 0xBF382118u, 0x3F1A06EA, 0x0, 0xC1200000u, 0x411FFFFF, 0x0, 0xBF382118u, 0x3F31DAF0, 0xC0A00000u, 0x41200000, 0x410A9066, 0xBEB1DAE0u, 0x3F382118, 0x3F1A06EA, 0x0, 0x41200000, 0x411FFFFF, 0x0, 0x3F382118, 0x3F31DAF0, 0x0, 0xC1200000u, 0x411FFFFF, 0x0, 0xBF382118u, 0x3F31DAF0, 0x40A00000, 0xC1200000u, 0x410A9066, 0x3EB1DAE0, 0xBF382118u, 0x3F1A06EA, 0x0, 0x41200000, 0x411FFFFF, 0x0, 0x3F382118, 0x3F31DAF0, 0x40A00000, 0x41200000, 0x410A9066, 0x3EB1DAE0, 0x3F382118, 0x3F1A06EA, 0x40A00000, 0xC1200000u, 0x410A9066, 0x3EB1DAE0, 0xBF382118u, 0x3F1A06EA, 0x410A9066, 0xC1200000u, 0x40A00000, 0x3F1A06EA, 0xBF382118u, 0x3EB1DAE0, 0x40A00000, 0x41200000, 0x410A9066, 0x3EB1DAE0, 0x3F382118, 0x3F1A06EA, 0x410A9066, 0x41200000, 0x40A00000, 0x3F1A06EA, 0x3F382118, 0x3EB1DAE0, 0x410A9066, 0xC1200000u, 0x40A00000, 0x3F1A06EA, 0xBF382118u, 0x3EB1DAE0, 0x41200000, 0xC1200000u, 0x0, 0x3F31DAF0, 0xBF382118u, 0x0, 0x410A9066, 0x41200000, 0x40A00000, 0x3F1A06EA, 0x3F382118, 0x3EB1DAE0, 0x41200000, 0x41200000, 0x0, 0x3F31DAF0, 0x3F382118, 0x0, 0xFF, 0x0 };

Sint16 poly_8D92D450B41AF90F4DD[] = { 0x8, 0x0, 0x2515, 0x4, 0xDCDCu, 0x9664u, 0xFFFFu, 0x6A2, 0x2840, 0x61, 0x18, 0x3, 0x0, 0x1, 0x2, 0x3, 0x3, 0x4, 0x5, 0x3, 0x45, 0x46, 0x47, 0x3, 0x6, 0x7, 0x8, 0x3, 0x42, 0x43, 0x44, 0x3, 0x9, 0xA, 0xB, 0x3, 0x3F, 0x40, 0x41, 0x3, 0xC, 0xD, 0xE, 0x3, 0x3C, 0x3D, 0x3E, 0x3, 0xF, 0x10, 0x11, 0x3, 0x39, 0x3A, 0x3B, 0x3, 0x12, 0x13, 0x14, 0x3, 0x36, 0x37, 0x38, 0x3, 0x15, 0x16, 0x17, 0x3, 0x33, 0x34, 0x35, 0x3, 0x18, 0x19, 0x1A, 0x3, 0x30, 0x31, 0x32, 0x3, 0x1B, 0x1C, 0x1D, 0x3, 0x2D, 0x2E, 0x2F, 0x3, 0x1E, 0x1F, 0x20, 0x3, 0x2A, 0x2B, 0x2C, 0x3, 0x21, 0x22, 0x23, 0x3, 0x27, 0x28, 0x29, 0x3, 0x24, 0x25, 0x26, 0x8, 0x0, 0x2515, 0x4, 0xDCDCu, 0x9664u, 0xFFFFu, 0x6A2, 0x2840, 0x3E, 0xC, 0x4, 0x48, 0x49, 0x4A, 0x4B, 0x4, 0x74, 0x75, 0x76, 0x77, 0x4, 0x6C, 0x6D, 0x6E, 0x6F, 0x4, 0x68, 0x69, 0x6A, 0x6B, 0x4, 0x64, 0x65, 0x66, 0x67, 0x4, 0x60, 0x61, 0x62, 0x63, 0x4, 0x5C, 0x5D, 0x5E, 0x5F, 0x4, 0x58, 0x59, 0x5A, 0x5B, 0x4, 0x54, 0x55, 0x56, 0x57, 0x4, 0x50, 0x51, 0x52, 0x53, 0x4, 0x4C, 0x4D, 0x4E, 0x4F, 0x5, 0x73, 0x73, 0x71, 0x72, 0x70, 0xFF };

NJS_CNK_MODEL attach_0050D518_cnk = { vertex_8D92D450B41AF90ED15, poly_8D92D450B41AF90F4DD, { 0 }, 14.14213f };

NJS_OBJECT Cylinder_debug = { NJD_EVAL_UNIT_POS | NJD_EVAL_UNIT_ANG | NJD_EVAL_UNIT_SCL | NJD_EVAL_BREAK, &attach_0050D518_cnk, 0, 0, 0, 0, 0, 0, 1, 1, 1, NULL, NULL };
#pragma warning(pop)

DataPointer(float, GlobalMatColorR, 0x25EFFD4);
DataPointer(float, GlobalMatColorG, 0x25EFFD8);
DataPointer(float, GlobalMatColorB, 0x25EFFDC);
DataPointer(float, GlobalMatColorA, 0x25EFFD0);
FunctionPointer(void, DrawObject, (NJS_OBJECT* a1), 0x42E730);
bool isColDebug = false;
void SetMaterialColorOffset(float r, float g, float b, float a)
{
	GlobalMatColorR = r;
	GlobalMatColorG = g;
	GlobalMatColorB = b;
	GlobalMatColorA = a;
	return;
}

void ResetMaterialColorOffset()
{
	GlobalMatColorR = 0.0f;
	GlobalMatColorG = 0.0f;
	GlobalMatColorB = 0.0f;
	GlobalMatColorA = 0.0f;
	return;
}

//set color according to the type of col (blue = not solid/player detection, green = solid, red = hurt)
void CheckAndSetColColor(CCL_INFO* Col) {

	if ((Col->attr >= 0x350 && Col->attr <= 0x1000)) {
		SetMaterialColorOffset(1.0, 0, 0, 0.0); //red
		return;
	}
	else {
		SetMaterialColorOffset(0.0, 1, 0.0, 0.0); //green
	}
}

void __cdecl DrawCollisionInfo(CollisionInfo* ColInfo)
{
	CollisionData* Col; // esi
	ObjectMaster* Obj; // eax
	EntityData1* data; // edi
	int v4; // ebx

	if (ColInfo)
	{
		Col = ColInfo->CollisionArray;
		Obj = ColInfo->Object;
		if (ColInfo->Count)
		{
			if (Col)
			{
				if (Obj)
				{
					data = Obj->Data1.Entity;
					if (data)
					{
						if (ColInfo->Count)
						{
							v4 = ColInfo->Count;
							do
							{
								DrawCol((CCL_INFO*)Col++, data);
								--v4;
							} while (v4);
						}
					}
				}
			}
		}
	}
}


void __cdecl DrawDebugCollision(ObjectMaster* a1)
{

	if (a1->Data1.Entity->Collision == nullptr)
		return;

	DrawCollisionInfo(a1->Data1.Entity->Collision);

}


#pragma endregion

//the following functions came from SADX
void njTranslateCol(CCL_INFO* Col, EntityData1* data)
{
	Uint32 Flag; // ebx
	Angle RotY; // eax
	Angle RotZ; // eax
	Angle RotX; // eax
	Angle RotZ2; // eax
	Angle RotX2; // eax
	Angle RotY2; // eax

	Flag = Col->attr;
	if ((Flag & 0x20) == 0)
	{
		njTranslateEx(&data->Position);
		if ((Flag & 0x8000) == 0)
		{
			if ((Flag & 0x200) != 0)
			{
				RotY = data->Rotation.y;
				if (RotY)
				{
					njRotateY(NULL, (unsigned __int16)RotY);
				}
				RotZ = data->Rotation.z;
				if (RotZ)
				{
					njRotateZ(NULL, (unsigned __int16)RotZ);
				}
				RotX = data->Rotation.x;
				if (RotX)
				{
					njRotateX(NULL, (unsigned __int16)RotX);
					njTranslateEx(&Col->center);
					return;
				}
			}
			else
			{
				RotZ2 = data->Rotation.z;
				if (RotZ2)
				{
					njRotateZ(NULL, (unsigned __int16)RotZ2);
				}
				RotX2 = data->Rotation.x;
				if (RotX2)
				{
					njRotateX(NULL, (unsigned __int16)RotX2);
				}
				RotY2 = data->Rotation.y;
				if (RotY2)
				{
					njRotateY(NULL, (unsigned __int16)RotY2);
				}
			}
		}
	}
	njTranslateEx(&Col->center);
}


void DrawColCylinderModel(EntityData1* data, CCL_INFO* col)
{
	Uint32 v3; // ebx
	Angle rotX; // eax
	float sx; // [esp+Ch] [ebp-8h]
	float sy; // [esp+10h] [ebp-4h]

	v3 = col->attr;
	sx = col->a * 0.1f;
	sy = col->b * 0.1f;
	njPushMatrixEx();
	njTranslateCol(col, data);
	if ((v3 & 0x20) == 0 && (v3 & 0x8000) == 0)
	{
		rotX = data->Rotation.x;
		if (rotX || data->Rotation.z)
		{
			if ((v3 & 0x200) != 0)
			{
				if (rotX)
				{
					njRotateX(NULL, (unsigned __int16)-LOWORD(data->Rotation.x));
				}
				if (data->Rotation.z)
				{
					njRotateZ(NULL, (unsigned __int16)-LOWORD(data->Rotation.z));
				}
				if (data->Rotation.y)
				{
					njRotateY(NULL, (unsigned __int16)-LOWORD(data->Rotation.y));
				}
			}
			else
			{
				if (data->Rotation.y)
				{
					njRotateY(NULL, (unsigned __int16)-LOWORD(data->Rotation.y));
				}
				if (data->Rotation.x)
				{
					njRotateX(NULL, (unsigned __int16)-LOWORD(data->Rotation.x));
				}
				if (data->Rotation.z)
				{
					njRotateZ(NULL, (unsigned __int16)-LOWORD(data->Rotation.z));
				}
			}
		}
	}
	njScale(NULL, sx, sy, sx);
	


	CheckAndSetColColor(col);
	DrawObject(&Cylinder_debug);
	ResetMaterialColorOffset();
	njPopMatrixEx();
}

void DrawColSphereModel(CCL_INFO* Col, EntityData1* Data)
{
	float XScale; // [esp+0h] [ebp-4h]

	XScale = Col->a * 0.1f;
	njPushMatrixEx();
	njTranslateCol(Col, Data);
	njScale(NULL, Col->a * 0.1f, Col->b * 0.1f, Col->c * 0.1f);
	
	CheckAndSetColColor(Col);
	DrawObject(&DebugSphere);
	ResetMaterialColorOffset();
	njPopMatrixEx();
}


void __cdecl DrawCol(CCL_INFO* Col, EntityData1* data)
{
	if (Col)
	{
		if (data)
		{
			switch (Col->form)
			{
			case 0:
				DrawColSphereModel(Col, data);
				break;
			case 1:
				DrawColCylinderModel(data, Col);
				break;
			default:
				return;
			}
		}
	}
}
